 Terraform Advanced â€“ Reusable EC2 Module [COMPLETE FROM SCRATCH]
________________________________________
ğŸ§‘â€ğŸ’» Goal:
Launch EC2 using reusable Terraform module from a new Ubuntu EC2 instance, starting from IAM setup.
âœ… Topic 38: Terraform Advanced â€“ Detailed Notes
________________________________________Conceptual Explanation 
In advanced Terraform, we mainly focus on two important things:
________________________________________
ğŸ”¹ 1. Modules â€“ Reusable Infrastructure Code
A module is like a function in programming. You define a set of resources once (e.g., EC2 instance, VPC, S3 bucket) and reuse it multiple times across different environments like dev, test, or prod.
ğŸ”¸ Why Use Modules?
â€¢	To avoid repeating code
â€¢	To make infrastructure scalable and organized
â€¢	To enforce standardized patterns
________________________________________
ğŸ”¹ 2. State Management (.tfstate file)
Terraform maintains a .tfstate file that keeps track of:
â€¢	What resources exist
â€¢	Their current state in AWS
â€¢	Resource dependencies
Without this file, Terraform canâ€™t tell what needs to be created, updated, or destroyed.
________________________________________
ğŸ”¹ 3. Remote State (with S3)
By default, .tfstate is stored locally. But in team environments or real projects, itâ€™s better to store it remotely using:
â€¢	ğŸ”’ S3 bucket (secured + versioned)
â€¢	ğŸ”‘ DynamoDB (for state locking â€“ optional)
ğŸ”¸ Why Remote State?
â€¢	Shared team access
â€¢	Version control
â€¢	Safety from local machine failures
________________________________________
ğŸ§  Roman Urdu Explanation (Samajhnay Ke Liye)
Terraform Modules aise hain jaise functions â€” aap aik dafa code likh kar, use baar baar reuse kar saktay hain (jaise EC2 instance, VPC, S3, etc.). Ye code har project ke liye alag se likhne ki zarurat nahi.
State File .tfstate ye batata hai ke kya cheez create hui, kya update ya delete hui. Agar ye file nahi hogi to Terraform confuse ho jaye ga.
Remote State (S3 bucket mein .tfstate file store karna) is liye use hota hai taake file:
â€¢	Secure ho
â€¢	Team ke sath share ho sake
â€¢	Kabhi delete na ho (versioning on hoti hai)
________________________________________
ğŸ” Real-Life Example:
Agar aap ke paas 10 clients hain, aur sab ke liye aapko same VPC + EC2 instance create karna hai:
â€¢	Aap module banao: vpc-module, ec2-module
â€¢	Phir reuse karo:
â€¢	module "client1" {
â€¢	  source = "./modules/ec2"
â€¢	  ami    = "ami-xxxx"
â€¢	}
â€¢	
â€¢	module "client2" {
â€¢	  source = "./modules/ec2"
â€¢	  ami    = "ami-yyyy"
â€¢	}
Jaise coding mein function likhte hain aur bar bar call karte hain, waise hi Terraform mein module banake use karte hain.
Aur .tfstate file aise hi hai jaise ek log file jo sab kuch record karti hai â€” usko S3 mein store karna matlab safe, backup, and shared rakhna.
________________________________________
ğŸ—‚ï¸ Breakdown of Steps:
Step	Description
1	Create IAM User with Policy
2	Install AWS CLI on EC2
3	Configure AWS CLI on EC2
4	Install Terraform
5	Write Module Files
6	Apply Terraform
________________________________________


Practical lab work
âœ… ğŸŸ¢ Step 1: IAM User + Policy Setup (On AWS Console)
ğŸ”¹ Go to AWS Console â†’ IAM
ğŸ”¹ Create New User â†’ e.g. terraform-user
ğŸ”¹ Tick âœ… Programmatic access
ğŸ“ Attach Policy:
Choose:
âœ… Attach policies directly
âœ… Select: AmazonEC2FullAccess
âœ… Optional but ideal: AmazonS3FullAccess (for remote state later)
ğŸ§  Roman Urdu: Ye IAM user Terraform ko AWS par kaam karne ki permission dega. EC2 full access zaroori hai.
________________________________________
ğŸ“„ Save:
Copy the following:
â€¢	âœ… Access Key ID
â€¢	âœ… Secret Access Key
(Save it securely â€“ youâ€™ll use this in CLI)
________________________________________
âœ… ğŸŸ¢ Step 2: EC2 Ubuntu Instance â€“ Install AWS CLI
Connect via PuTTY or terminal:
ğŸ§± Update & Install AWS CLI:
AWS CLI Manual Install karo (Agar apt install nahi hota)
sudo apt update
sudo apt install unzip -y
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install
aws --version   # check karo ke install ho gaya ya nahi
________________________________________
âœ… ğŸŸ¢ Step 3: Configure AWS CLI
Run:
aws configure
Enter the values:
AWS Access Key ID     [paste from IAM user]
AWS Secret Access Key [paste from IAM user]
Default region name   us-east-2
Default output format json
ğŸ§  Roman Urdu: Ab aapka EC2 instance AWS se authenticated hai via CLI.
________________________________________
âœ… ğŸŸ¢ Step 4: Install Terraform on EC2
Step-by-step Terraform installation:
sudo apt update
sudo apt install -y gnupg software-properties-common curl

curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg

echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | \
sudo tee /etc/apt/sources.list.d/hashicorp.list

sudo apt update
sudo apt install terraform -y
Verify:
terraform -version
âœ… Should return something like Terraform v1.8.0
ğŸ§  Roman Urdu: Ab Terraform ready hai aapke EC2 par chalne ke liye.
________________________________________
âœ… ğŸŸ¢ Step 5: Create Terraform Module Project
mkdir terraform-project
cd terraform-project
mkdir -p modules/ec2-instance
touch main.tf modules/ec2-instance/ec2.tf modules/ec2-instance/variables.tf
________________________________________
ğŸ”§ Edit: modules/ec2-instance/ec2.tf
nano modules/ec2-instance/ec2.tf
Paste:
resource "aws_instance" "myec2" {
  ami           = var.ami
  instance_type = var.instance_type

  tags = {
    Name = "ModularInstance"
  }
}
________________________________________
ğŸ”§ Edit: modules/ec2-instance/variables.tf
nano modules/ec2-instance/variables.tf
Paste:
variable "ami" {}
variable "instance_type" {}
________________________________________

Note:
â€¢	ami ID aapko AWS Console ya CLI se apne region ke liye nikalni hogi.
Ubuntu 20.04 ke liye AMI ID nikalne ka command
aws ec2 describe-images \
    --owners 099720109477 \
    --filters "Name=name,Values=ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*" \
    --query 'Images[*].[ImageId,Name]' \
    --output table \
    --region us-east-2
________________________________________
ğŸ”§ Edit: main.tf
nano main.tf
Paste:
provider "aws" {
  region = "us-east-2"
}

module "web" {
  source        = "./modules/ec2-instance"
  ami           = "ami-0c55b159cbfafe1f0"
  instance_type = "t2.micro"
}
________________________________________
âœ… ğŸŸ¢ Step 6: Apply Terraform
terraform init
terraform plan
terraform apply
âœ… Type yes when asked.
________________________________________
ğŸ“ Final Folder Structure:
terraform-project/
â”œâ”€â”€ main.tf
â””â”€â”€ modules/
    â””â”€â”€ ec2-instance/
        â”œâ”€â”€ ec2.tf
        â””â”€â”€ variables.tf
________________________________________
âœ… Final Outcome:
EC2 instance launched from modular Terraform code using:
â€¢	Installed CLI
â€¢	Configured IAM credentials
â€¢	Fresh Terraform installation
________________________________________




Assignment 
ğŸŸ¢ Step 1: Launch EC2 (Ubuntu 22.04)
Detail	Value
Region	us-east-2
Instance	t2.micro
Security	Allow port 22
OS	Ubuntu 22.04
SSH into your instance after creation.
________________________________________
ğŸŸ¢ Step 2: Install Terraform
sudo apt update
sudo apt install -y gnupg software-properties-common curl
curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
sudo apt update
sudo apt install terraform -y
terraform -v
________________________________________
ğŸŸ¢ Step 3: Install AWS CLI
sudo apt install unzip -y
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install
aws --version
________________________________________
ğŸŸ¢ Step 4: Create IAM User for Terraform
1.	Go to AWS Console â†’ IAM
2.	Create a new user: terraform-user
3.	âœ… Enable Programmatic access
4.	Attach policies:
o	AmazonEC2FullAccess
o	AmazonS3FullAccess
5.	Download:
o	Access key ID
o	Secret access key
________________________________________
ğŸŸ¢ Step 5: Configure AWS CLI
aws configure
Enter the credentials:
â€¢	Access Key ID: your_key_here
â€¢	Secret Access Key: your_secret_here
â€¢	Region: us-east-2
â€¢	Output Format: json
________________________________________
ğŸŸ¢ Step 6: Create S3 Bucket (for remote state)
aws s3api create-bucket \
  --bucket my-terraform-state-bucket \
  --region us-east-2 \
  --create-bucket-configuration LocationConstraint=us-east-2
Enable versioning:
aws s3api put-bucket-versioning \
  --bucket my-terraform-state-bucket \
  --versioning-configuration Status=Enabled
________________________________________
ğŸŸ¢ Step 7: Project Directory Setup
mkdir terraform-project
cd terraform-project
mkdir -p modules/ec2-instance
________________________________________
Note:
â€¢	ami ID aapko AWS Console ya CLI se apne region ke liye nikalni hogi.
Ubuntu 20.04 ke liye AMI ID nikalne ka command
aws ec2 describe-images \
    --owners 099720109477 \
    --filters "Name=name,Values=ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*" \
    --query 'Images[*].[ImageId,Name]' \
    --output table \
    --region us-east-2
________________________________________
ğŸ“„ main.tf
terraform {
  backend "s3" {
    bucket = "my-terraform-state-bucket"
    key    = "env/dev/terraform.tfstate"
    region = "us-east-2"
  }
}

provider "aws" {
  region = "us-east-2"
}

module "web" {
  source        = "./modules/ec2-instance"
  ami           = "ami-0c55b159cbfafe1f0"  # âœ… Ubuntu 20.04 Free Tier in us-east-2
  instance_type = "t2.micro"
}
________________________________________
ğŸ“„ modules/ec2-instance/ec2.tf
resource "aws_instance" "myec2" {
  ami           = var.ami
  instance_type = var.instance_type

  tags = {
    Name = "ModularInstance"
  }
}
________________________________________
ğŸ“„ modules/ec2-instance/variables.tf
variable "ami" {
  description = "AMI ID for the EC2 instance"
  type        = string
}

variable "instance_type" {
  description = "EC2 instance type"
  type        = string
}
________________________________________
ğŸŸ¢ Step 8: Initialize, Plan, Apply
terraform init      # Initializes + configures S3 backend
terraform plan      # Shows what will be created
terraform apply     # Deploys infrastructure
________________________________________
âœ… Final Output
â€¢	EC2 instance created via module
â€¢	Remote state stored in S3
â€¢	IAM user access working
â€¢	No AMI or region mismatch errors
________________________________________
ğŸ§¾ Checklist: All Set?
Task	Done?
IAM User Created + Configured	âœ…
S3 Bucket Created with Versioning	âœ…
Folder Structure Modular	âœ…
ami & instance_type passed via module	âœ…
Remote State Stored in S3	âœ…
EC2 Instance Created with Tag	âœ…
________________________________________
