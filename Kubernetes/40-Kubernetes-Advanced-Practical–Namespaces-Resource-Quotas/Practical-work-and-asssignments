ğŸ“‚ Kubernetes Advanced â€“ Practical Work & Assignments
_____________________________________________________________

âœ… 1. Environment Setup (EC2 Ubuntu 22.04)
- Update & upgrade system:
  sudo apt update && sudo apt upgrade -y
- Install Docker:
  sudo apt install -y docker.io
  sudo systemctl enable docker --now

âœ… 2. Add Kubernetes Repo & Install Tools
- Install required packages:
  sudo apt install -y apt-transport-https ca-certificates curl gpg
- Add Kubernetes repo:
  sudo mkdir -p /etc/apt/keyrings
  curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.29/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.29/deb/ /" | sudo tee /etc/apt/sources.list.d/kubernetes.list
- Install kubeadm, kubelet, kubectl, cri-tools:
  sudo apt update
  sudo apt install -y kubelet kubeadm kubectl cri-tools
  sudo apt-mark hold kubelet kubeadm kubectl

âœ… 3. Enable Kernel Modules for Networking
- Load br_netfilter module:
  cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
  br_netfilter
  EOF
  sudo modprobe br_netfilter
- Setup sysctl params:
  cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
  net.bridge.bridge-nf-call-iptables  = 1
  net.bridge.bridge-nf-call-ip6tables = 1
  net.ipv4.ip_forward                 = 1
  EOF
  sudo sysctl --system

âœ… 4. Disable Swap
- Disable swap permanently:
  sudo swapoff -a
  sudo sed -i '/ swap / s/^/#/' /etc/fstab

âœ… 5. Optional: Fix /etc/hosts if DNS fails
echo "127.0.0.1 localhost" | sudo tee /etc/hosts
echo "$(curl -s ifconfig.me) master-node" | sudo tee -a /etc/hosts

âœ… 6. Init Kubernetes Cluster
sudo kubeadm init --pod-network-cidr=10.244.0.0/16
# Agar iptables warnings aaye:
sudo kubeadm init --pod-network-cidr=10.244.0.0/16 --ignore-preflight-errors=FileContent--proc-sys-net-bridge-bridge-nf-call-iptables

âœ… 7. Setup kubectl for current user
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
# OR root user ke liye:
export KUBECONFIG=/etc/kubernetes/admin.conf
echo 'export KUBECONFIG=/etc/kubernetes/admin.conf' >> ~/.bashrc
source ~/.bashrc

âœ… 8. Install Flannel CNI
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

âœ… 9. Verify Node & Flannel
kubectl get nodes
kubectl get pods -n kube-flannel

ğŸ§ª Namespace & Resource Quota

âœ… 10. Create Namespaces
kubectl create namespace dev
kubectl create namespace qa

âœ… 11. Apply ResourceQuota on dev
- Create YAML file dev-quota.yaml:
nano dev-quota.yaml
Paste:
apiVersion: v1
kind: ResourceQuota
metadata:
  name: dev-quota
  namespace: dev
spec:
  hard:
    pods: "5"
    requests.cpu: "1"
    requests.memory: "1Gi"
    limits.cpu: "2"
    limits.memory: "2Gi"
- Save & exit (CTRL+O â†’ Enter â†’ CTRL+X)
- Apply YAML:
kubectl apply -f dev-quota.yaml
- Verify:
kubectl describe resourcequota dev-quota -n dev

âœ… 12. Deploy Pod in dev
kubectl run nginx --image=nginx -n dev
kubectl get pods -n dev

âœ… 13. Test Quota Limit (Optional)
# Maximum 5 pods allowed, 6th fail hona chahiye
kubectl run nginx2 --image=nginx -n dev
kubectl run nginx3 --image=nginx -n dev
kubectl run nginx4 --image=nginx -n dev
kubectl run nginx5 --image=nginx -n dev
kubectl run nginx6 --image=nginx -n dev   # âŒ Fail due to quota

âœ… 14. Reboot-Proof Fix
sudo systemctl enable containerd
sudo systemctl enable kubelet

âœ… 15. Troubleshooting Essentials
# Check kube-apiserver
sudo crictl ps -a | grep kube-apiserver
# Check logs
sudo crictl logs <container_id>
# CoreDNS status
kubectl get pods -n kube-system
kubectl describe pod -n kube-system coredns-xxxx
# Restart services
sudo systemctl daemon-reexec
sudo systemctl restart containerd kubelet

ğŸ“Œ Assignment Notes:
- Namespace create karke multi-team isolation practice karo.
- ResourceQuota set karke pod limit enforce karo.
- Deployment test karo aur quota exceed karke error verify karo.
- Reboot ke baad pods aur kubelet containerd ensure karo ke running hain.
